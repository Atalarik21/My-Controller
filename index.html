<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SOIL SYSTEM CONTROL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body {
            margin: 0;
            font-family: Arial;
            background-color: #111;
            color: white;
        }

        .header {
            padding: 15px;
            background-color: #222;
            font-size: 22px;
            font-weight: bold;
            position: relative;
        }

        /* Tombol WiFi Setup */
        .wifi-btn {
            position: absolute;
            right: 15px;
            top: 12px;
            background-color: #0af;
            color: black;
            padding: 6px 12px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
        }

        .container { margin: 20px; }

        .card {
            background-color: #222;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px;
            width: 100%;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            margin-top: 10px;
            cursor: pointer;
        }

        .btn-on { background-color: #00e676; }
        .btn-off { background-color: #ff1744; }

        /* ----------- POPUP WIFI SETUP ----------- */
        #wifiPanel {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            padding: 20px;
        }

        .wifi-box {
            background: #222;
            padding: 20px;
            border-radius: 10px;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            margin-top: 10px;
            font-size: 16px;
        }

        .btn-save {
            width: 100%;
            background: #0af;
            padding: 12px;
            border: none;
            color: black;
            border-radius: 10px;
            font-size: 18px;
            margin-top: 20px;
        }

        .close-btn {
            background: #ff1744;
            padding: 8px 12px;
            color: white;
            float: right;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <!-- Header -->
    <div class="header">
        SOIL SYSTEM
        <div class="wifi-btn" onclick="openWifi()">WiFi Setup</div>
    </div>

    <!-- Kontrol Relay -->
    <div class="container">
        <div class="card">
            <h3>Relay 1</h3>
            <button class="btn btn-on" onclick="sendCmd('esp/relay1','ON')">ON</button>
            <button class="btn btn-off" onclick="sendCmd('esp/relay1','OFF')">OFF</button>
        </div>

        <div class="card">
            <h3>Relay 2</h3>
            <button class="btn btn-on" onclick="sendCmd('esp/relay2','ON')">ON</button>
            <button class="btn btn-off" onclick="sendCmd('esp/relay2','OFF')">OFF</button>
        </div>
    </div>

    <!-- POPUP WIFI SETUP -->
    <div id="wifiPanel">
        <div class="wifi-box">
            <div class="close-btn" onclick="closeWifi()">X</div>
            <h2>WiFi Setup</h2>

            <label>SSID WiFi</label>
            <select id="ssid"></select>

            <label>Password</label>
            <input type="password" id="pass">

            <button class="btn-save" onclick="saveWifi()">Save & Reboot</button>
        </div>
    </div>

    <script>

        /* ---------------------- Relay Control ---------------------- */
        function sendCmd(topic, msg) {
            fetch("/api/mqtt?topic=" + topic + "&msg=" + msg)
                .then(r => r.text())
                .then(t => console.log(t));
        }

        /* ---------------------- WiFi Panel ---------------------- */
        function openWifi() {
            document.getElementById("wifiPanel").style.display = "block";

            // Load daftar SSID dari ESP
            fetch("/wifi_scan")
            .then(r => r.json())
            .then(list => {
                let sel = document.getElementById("ssid");
                sel.innerHTML = "";
                list.forEach(s => {
                    let o = document.createElement("option");
                    o.value = s;
                    o.innerHTML = s;
                    sel.appendChild(o);
                });
            });
        }

        function closeWifi() {
            document.getElementById("wifiPanel").style.display = "none";
        }

        /* ---------------------- Save WiFi Config ---------------------- */
        function saveWifi() {
            let data = {
                ssid: document.getElementById("ssid").value,
                pass: document.getElementById("pass").value
            };

            fetch("/api/save_wifi", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(data)
            })
            .then(r => r.text())
            .then(t => {
                alert("WiFi Saved!\nDevice will reboot...");
            });
        }

    </script>

</body>
</html>
