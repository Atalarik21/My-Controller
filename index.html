<script>
  // Variabel untuk melacak status koneksi dan timer
  let lastResponseTime = Date.now();
  let statusTimeout;

  function updateStatus() {
    const currentTime = Date.now();
    const timeDiff = currentTime - lastResponseTime;

    if (timeDiff > 5000) {  // Jika tidak ada respons lebih dari 5 detik
      document.getElementById('status-led').style.background = 'red';
      document.getElementById('status-text').textContent = 'Offline';
    }
  }

  // Set interval untuk memeriksa status setiap detik
  setInterval(updateStatus, 1000);

  // --- MQTT Connection ---
  const client = mqtt.connect('wss://9fa472bc0c754eb488098ea8f4bb27f8.s1.eu.hivemq.cloud:8884/mqtt', {
    clientId: 'webClient_' + Math.random().toString(16).substr(2, 8),
    username: 'Attamationhtml',
    password: 'Attamationhtml21',
    clean: true,
    connectTimeout: 4000
  });

  client.on('connect', () => {
    console.log('Connected to MQTT Broker');
    document.getElementById('status-led').style.background = 'lime';
    document.getElementById('status-text').textContent = 'Online';
    client.subscribe('esp/status/relay1');
    client.subscribe('esp/status/relay2');
    client.publish('esp/get_status', 'REQ');
    lastResponseTime = Date.now();  // Reset timer saat pertama kali terhubung
  });

  client.on('message', (topic, message) => {
    const state = message.toString();
    let relay = '';
    if (topic.includes('relay1')) {
      relay = 'relay1';
    } else if (topic.includes('relay2')) {
      relay = 'relay2';
    }
    if (relay) {
      const checkbox = document.getElementById(relay + 'Btn');
      const card = checkbox.closest('.device-card');
      const status = card.querySelector('.device-status');

      checkbox.checked = state === 'ON';
      status.textContent = state;
      lastResponseTime = Date.now();  // Reset timer setiap kali menerima status baru
    }
  });

  client.on('error', (error) => {
    console.error('Connection error:', error);
    document.getElementById('status-led').style.background = 'red';
    document.getElementById('status-text').textContent = 'Offline';
  });

  client.on('close', () => {
    console.log('Disconnected');
    document.getElementById('status-led').style.background = 'red';
    document.getElementById('status-text').textContent = 'Offline';
  });

  // Deteksi offline dan hubungkan ulang
  client.on('offline', () => {
    console.log('MQTT client offline');
    document.getElementById('status-led').style.background = 'red';
    document.getElementById('status-text').textContent = 'Offline';
  });

  document.getElementById('relay1Btn').addEventListener('change', (e) => {
    const state = e.target.checked ? 'ON' : 'OFF';
    client.publish('esp/relay1', state);
    lastResponseTime = Date.now();  // Reset timer saat tombol ditekan
  });

  document.getElementById('relay2Btn').addEventListener('change', (e) => {
    const state = e.target.checked ? 'ON' : 'OFF';
    client.publish('esp/relay2', state);
    lastResponseTime = Date.now();  // Reset timer saat tombol ditekan
  });
</script>
